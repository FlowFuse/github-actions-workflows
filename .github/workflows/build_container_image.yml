name: Build container image

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to build the image for'
        required: true
        type: string
        default: 'stage'
      image_name:
        description: 'Name of the image to build'
        required: true
        type: string
      image_tag_prefix:
        description: 'Prefix for the image tag'
        required: false
        type: string
        default: ''
      package_dependencies:
        description: 'List of dependencies to update'
        type: string
        required: false
        default: ''
      build_context:
        description: 'Path to the build context'
        type: string
        required: true
      build_platforms:
        description: 'Platforms to build the image for'
        type: string
        required: false
        # default: '["linux/amd64","linux/arm64"]'
        default: |- 
          linux/amd64
          linux/arm64
      dockerfile_path:
        description: 'Path to the Dockerfile, within $build_context, used for image build'
        type: string
        required: false
        default: 'Dockerfile'
      npm_registry_url:
        description: 'NPM registry URL'
        type: string
        required: false
        default: registry.npmjs.org
      aws_access_key_id:
        description: 'AWS access key ID'
        type: string
        required: false
      scan_image:
        description: 'Scan the image for vulnerabilities'
        type: boolean
        default: false
    secrets:
      npm_registry_auth_token:
        description: 'NPM registry authentication token'
        required: false
      aws_access_key_id:
        description: 'AWS access key ID'
        required: true
      aws_access_key_secret:
        description: 'AWS access key secret'
        required: true
      docker_hub_secret:
        description: 'Docker Hub password'
        required: false
    outputs:
      image:
        description: 'Image tag'
        value: ${{ jobs.container.outputs.image }}

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     platform: ${{ fromJson(inputs.build_platforms) }}
    permissions:
      packages: read
      contents: read
    outputs:
      image: ${{ steps.set_outputs.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v2

      - name: Set release name and image tag
        run: | 
          echo "release_name=nightly" >> $GITHUB_ENV
          echo "image_tag=nightly-$(date +%Y%m%d%H%m%S)" >> $GITHUB_ENV
          
      - name: Set build tag
        if: |
          env.release_name == 'nightly' &&
          inputs.image_name == 'node-red'
        run:
          if [ "${{ env.release_name }}" == "nightly" ]; then
            echo "build_tag=nightly" >> $GITHUB_ENV ;
          else
            echo "build_tag=latest" >> $GITHUB_ENV ;
          fi

      - name: Set dependecies versions
        if: ${{ inputs.package_dependencies != '' }}
        working-directory: ${{ inputs.build_context }}
        run: |
          for dependency in $(echo "${{ inputs.package_dependencies }}" | tr '\n' ' ')
          do
            echo "Updating $dependency to ${{ env.release_name }}"
            cat package.json | jq ".dependencies[\"$dependency\"] = \"${{ env.release_name }}\"" > package.json-patched
            mv package.json-patched package.json
          done
          cat package.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-access-key-id: ${{ secrets.aws_access_key_id }}
          aws-secret-access-key: ${{ secrets.aws_access_key_secret }}
          aws-region: eu-west-1

      - name: Login to container registry
        id: registry
        uses: aws-actions/amazon-ecr-login@v1

      - name: Get image metadata
        id: image_metadata
        uses: docker/metadata-action@v3
        with:
          tags: |
            type=raw,prefix=${{ inputs.image_tag_prefix }},value=${{ env.release_name }}
          flavor: |
            latest=false
          images: |
            ${{ steps.registry.outputs.registry }}/flowforge/${{ inputs.image_name }}

      - name: Build and load for scan
        uses: docker/build-push-action@v4
        with:
          context: ${{ inputs.build_context }}
          file: "${{ inputs.build_context }}/${{ inputs.dockerfile_path }}"
          tags: "${{ inputs.image_name }}:${{ env.image_tag }}"
          build-args: |
            REGISTRY=${{ inputs.npm_registry_url }}
            REGISTRY_TOKEN=${{ secrets.npm_registry_auth_token }}
            BUILD_TAG=${{ env.build_tag }}
          outputs: type=docker

      - name: Scan for vulnerabilities
        id: scan
        uses: crazy-max/ghaction-container-scan@v2
        with:
          image: "${{ inputs.image_name }}:${{ env.image_tag }}"
          dockerfile: "${{ inputs.build_context }}/${{ inputs.dockerfile_path }}"
      
      - name: Build container image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: ${{ inputs.build_context }}
          file: "${{ inputs.build_context }}/${{ inputs.dockerfile_path }}"
          # tags: | 
          #   ${{ steps.image_metadata.outputs.tags }}
          #   "${{ steps.registry.outputs.registry }}/flowforge/${{ inputs.image_name }}:${{ env.image_tag }}"
          tags: "${{ inputs.image_name }}:${{ env.image_tag }}"
          platforms: ${{ inputs.build_platforms }}
          build-args: |
            REGISTRY=${{ inputs.npm_registry_url }}
            REGISTRY_TOKEN=${{ secrets.npm_registry_auth_token }}
            BUILD_TAG=${{ env.build_tag }}
          outputs: type=tar,dest=${{ github.workspace }}/${{ inputs.image_name }}.image.tar

      - name: debug directory
        run: | 
          ls -la ${{ github.workspace }}
      
      - name: Scan container image for vulnerabilities
        if: ${{ inputs.scan_image == true }}
        uses: flowforge/github-actions-workflows/actions/scan_container_image@main
        with:
          image_ref: "${{ inputs.image_name }}:${{ env.image_tag }}"
  
      - name: Set job outputs
        id: set_outputs
        run: |
          echo "image=${{ inputs.image_name }}:${{ env.image_tag }}" >> $GITHUB_OUTPUT

      - name: debug directory
        run: | 
          ls -la ${{ github.workspace }}

      - name: Compress image archive
        run: gzip ${{ github.workspace }}/${{ inputs.image_name }}.image.tar

      - name: debug artifacts
        run: | 
          ls -la ${{ github.workspace }}
          ls -la ${{ github.workspace }}/${{ inputs.image_name }}.image.tar.gz

      - name: Publish container image as artifact
        uses: actions/upload-artifact@v3.1.2
        with:
          name: ${{ inputs.image_name }}
          path: "${{ github.workspace }}/${{ inputs.image_name }}.image.tar.gz"
          retention-days: 2
